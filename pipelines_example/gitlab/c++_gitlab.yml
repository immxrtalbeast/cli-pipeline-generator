name: C++ CI/CD Pipeline (Cmake)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  setup:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Debug, Release]
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make
      if: matrix.os == 'ubuntu-latest'
    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{ matrix.build_type }}
  test:
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Debug]
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ make 
      if: matrix.os == 'ubuntu-latest'
    - name: Configure with tests
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DBUILD_TESTING=ON

    - name: Build tests
      run: cmake --build build --target all test

    - name: Run tests
      run: ctest --test-dir build --output-on-failure
  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cppcheck
    - name: Run cppcheck
      run: cppcheck --enable=all --inconclusive --std=c++${{ env.CPP_STANDARD }} src/ include/
    - name: Run clang-tidy
      run: |
        find src/ include/ -name '*.cpp' -o -name '*.h' | xargs clang-tidy -p build/
      if: env.BUILD_TOOL == 'cmake'
  build-release:
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v3
    - name: Install compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++-11
      if: matrix.os == 'ubuntu-latest'
    - name: Configure Release
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-11

    - name: Build Release
      run: cmake --build build --config Release --parallel

    - name: Run benchmarks
      run: ./build/benchmarks/benchmark_runner
      if: exists('benchmarks')
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: cpp-${{ matrix.os }}-release
        path: |
          build/**
          *.exe
          *.dll
          *.so
          *.dylib
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install clang-format
      run: sudo apt-get install -y clang-format
    - name: Check code format
      run: |
        find src/ include/ -name '*.cpp' -o -name '*.h' | xargs clang-format -i --dry-run -Werror
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Doxygen
      run: sudo apt-get install -y doxygen graphviz
    - name: Generate documentation
      run: doxygen Doxyfile
      if: exists('Doxyfile')
    - name: Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: cpp-docs
        path: docs/
  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v3
    - name: Install coverage tools
      run: sudo apt-get install -y gcovr lcov
    - name: Build with coverage
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage"
        cmake --build build
    - name: Run tests with coverage
      run: |
        ./build/tests/unit_tests
        gcovr --root . --xml-pretty --output coverage.xml
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage.xml
